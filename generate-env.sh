#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ .env Ñ„Ð°Ð¹Ð»Ð° Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð² CI/CD Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸

set -e

ENV_FILE=".env"

echo "ðŸ”§ Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ .env Ñ„Ð°Ð¹Ð»..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
required_vars=(
    "DB_URL"
    "POSTGRES_DB" 
    "POSTGRES_USER"
    "POSTGRES_PASSWORD"
    "JWT_SECRET"
    "QUART_SCHEMA_CONVERT_CASING"
    "ML_API_URL"
    "REDIS_HOST"
    "REDIS_PORT"
    "REDIS_DB"
    "REDIS_PASSWORD"
)

for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ $var Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
        exit 1
    fi
done

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»
# ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ DB_URL Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ asyncpg Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸
ASYNC_DB_URL=$(echo "$DB_URL" | sed 's/postgresql:/postgresql+asyncpg:/')

cat > "$ENV_FILE" << EOF
# Database Configuration
DB_URL=${ASYNC_DB_URL}
ALEMBIC_DB_URL=${DB_URL}
POSTGRES_DB=${POSTGRES_DB}
POSTGRES_USER=${POSTGRES_USER}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

# JWT Configuration
JWT_SECRET=${JWT_SECRET}

# Quart Configuration
QUART_SCHEMA_CONVERT_CASING=${QUART_SCHEMA_CONVERT_CASING}

# ML API Configuration
ML_API_URL=${ML_API_URL}

# Redis Configuration
REDIS_HOST=${REDIS_HOST}
REDIS_PORT=${REDIS_PORT}
REDIS_DB=${REDIS_DB}
REDIS_PASSWORD=${REDIS_PASSWORD}

# Generated at: $(date)
EOF

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð°
chmod 600 "$ENV_FILE"

echo "âœ… .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½: $ENV_FILE"
echo "ðŸ”’ ÐŸÑ€Ð°Ð²Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹: 600 (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ† Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ/Ð¿Ð¸ÑÐ°Ñ‚ÑŒ)"

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ (Ð±ÐµÐ· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²)
echo ""
echo "ðŸ“‹ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ .env Ñ„Ð°Ð¹Ð»Ð°:"
echo "========================"
sed 's/=.*/=***/' "$ENV_FILE"
echo "========================"
