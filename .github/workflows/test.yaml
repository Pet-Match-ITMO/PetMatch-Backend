name: tests

on: 
    push: {}
    workflow_call: {}

jobs:
    linter:
        runs-on: ubuntu-latest
        env:
            UV_CACHE_DIR: /tmp/.uv-cache
        steps:
            - uses: actions/checkout@v5

            - name: "Set up Python"
              uses: actions/setup-python@v5
              with:
                python-version-file: ".python-version"

            - name: Install UV
              uses: astral-sh/setup-uv@v6
              with:
                version: "0.8.22"
                enable_cache: true
            
            - name: Install the project
              run: uv sync
            
            - name: Run linter
              run: uv run ruff check
    
    pytest:
        runs-on: ubuntu-latest

        services:
          redis:
            image: redis:7-alpine
            ports:
              - "6379:6379"

        env:
            UV_CACHE_DIR: /tmp/.uv-cache
        steps:
            - uses: actions/checkout@v5

            - name: "Set up Python"
              uses: actions/setup-python@v5
              with:
                python-version-file: ".python-version"

            - name: Install UV
              uses: astral-sh/setup-uv@v6
              with:
                version: "0.8.22"
                enable_cache: true
            
            - name: Install the project
              run: uv sync
            
            - name: Run tests
              env:
                REDIS_HOST: localhost
                REDIS_PORT: 6379
                REDIS_DB: 0
                REDIS_PASSWORD: ""
                TEST_DB_URL: ${{ vars.TEST_DB_URL }}
                JWT_SECRET: ${{ vars.JWT_SECRET }}
                QUART_SCHEMA_CONVERT_CASING: ${{ vars.QUART_SCHEMA_CONVERT_CASING }}
                PYTHONPATH: ${{ github.workspace }}/app
                ML_API_URL: http://localhost:8000/
              run: uv run pytest -v
