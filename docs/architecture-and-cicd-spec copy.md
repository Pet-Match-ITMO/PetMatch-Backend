# Рекомендации по стеку, архитектуре и CI/CD

## Цель документа

Этот документ описывает рекомендуемые технологии, архитектурные принципы, библиотеки и принципы развертывания для нового backend‑проекта (ASGI, Python).

## Основной стек (рекомендованный)

- **Язык и рантайм**: Python 3.11 (asyncio-first)
- **Веб-слой (ASGI)**:
  - Quart (асинхронный Flask‑подобный фреймворк)
  - Uvicorn (ASGI‑сервер, HTTPS)
  - quart-cors (CORS)
- **Клиенты и интеграции**:
  - aiohttp (асинхронный HTTP‑клиент)
  - requests (синхронный HTTP‑клиент для вспомогательных задач)
- **Данные и доступ**:
  - PostgreSQL (оперативное хранилище)
  - sqlalchemy
  - pydantic v2 (валидация и контракты данных)
- **Фоновые задачи**: APScheduler (планировщик)
- **Безопасность и крипто**: cryptography, pyotp
- **Утилиты/мэппинг**: dacite
- **CLI/зависимости/сборка**: UV; Docker / docker compose

## Архитектура (предметно)

- **Blueprints по доменам и общим функциям**:

  - Отдельные blueprints для доменных модулей (например, `auth`, `catalog`, `billing`) и для `common`, регистрируются с префиксами (например, `/api/auth`, `/api/catalog`, `/api/common`).
  - Маршруты модулей располагаются в `app/routes/<module>/`, общие — в `app/routes/common/`. Агрегирующий регистратор — `app/routes/adapter.py`.
- **Middlewares уровня транспорта** (`app/middlewares.py`):

  - Проверка обязательных параметров запроса, привязка контекста в `quart.g` (например, `g.clientId`, `g.profile`).
  - Аутентификация/авторизация: расшифровка токена/сессии, валидация и помещение результата в контекст запроса.
- **Domain слой**:

  - Основная Логика — в `app/src/api/`.
  - Pydantic‑модели сгруппированы в `app/src/api/models/` (доменные сущности, параметры, статусы), используются как DTO между слоями и для сериализации ответов API.
- **Хранилища/репозитории (Infrastructure/Data Access)**:

  - Класс‑фасад БД в `app/database.py` инкапсулирует клиент БД, хранит ссылки на репозитории (`app/src/database/*`) и предоставляет высокоуровневые операции (сессии, токены, кэши, параметры и статусы).
  - Инициализация индексов и кэшей — в методах `initialize()` соответствующих стораджей.
- **Фоновые задачи**:

  - Планировщик `APScheduler` инициализируется в `app/sheduler.py` и запускается из точки входа; задачи: периодическое обновление кэшей, синхронизация статусов, сервисные операции.
- **Точка входа и сервер**:

  - Точка входа поднимает ASGI‑сервер Uvicorn с SSL‑сертификатами, выбирает порт/профиль по конфигурации, регистрирует остановку планировщика при завершении.
- **Поток обработки запроса**:

  1) HTTP‑запрос → 2) Blueprint‑маршрут (по домену/общий) → 3) Middleware (валидация, аутентификация, контекст) → 4) Сервис/адаптер (доменные операции, внешние API) → 5) Хранилище (репозитории БД) → 6) Ответ (DTO/JSON).
- **Расширяемость**:

  - Добавление нового модуля: создать каталог `app/routes/<module>/` (blueprint), реализация в `app/src/api/<feature>/`
    Необходимо зарегистрировать blueprint в фабрике приложения.

## Основные библиотеки и их назначение

- **quart / uvicorn / quart-cors**: веб‑слой ASGI, CORS, HTTPS
- **motor**: асинхронный доступ к MongoDB
- **pydantic v2**: схемы данных, валидация DTO/контрактов API
- **aiohttp / requests**: вызовы внешних HTTP API (async/sync)
- SDK клиентов внешних провайдеров (по необходимости)
- **APScheduler**: планирование фоновых задач
- **cryptography / pyotp**: криптография, одноразовые коды
- **dacite**: приведение dict → dataclass (при необходимости)
- **python-dotenv**: загрузка локальных конфигов (.env) в dev
- **Poetry**: управление зависимостями и окружением

## Организация кода (рекомендуемая)

- `app/`:
  - `routes/`: transport‑слой (эндпоинты) + blueprints по доменам (`auth/`, `catalog/`, и т. п.) и общие
  - `middlewares.py`: валидация контекста запроса, аутентификация/авторизация
  - `database.py`: фабрика/инициализация доступа к БД и хранилищам
  - `settings.py`: базовые настройки, логгер, порты
  - `sheduler.py`: планировщик задач (инициализация и запуск)
- `app/src/`:
  - `api/common/models/`: pydantic‑сущности, контракты, доменные типы
  - `api/<provider>/`: адаптеры/клиенты конкретных внешних провайдеров
  - `database/`: репозитории/хранилища (инфраструктурный слой)
  - `encryption/`: крипто‑примитивы/утилиты
  - `utils/`: декораторы, парсеры, конвертеры типов, ответы

Границы модулей: общий слой не импортирует конкретные реализации; адаптеры провайдеров работают через контракты общего слоя.

## Конфигурация и секреты

- Источники: переменные окружения (+ `.env` в dev), секреты в CI/CD
- Обязательные переменные:
  - **DB_URI** (подключение к БД — MongoDB/PostgreSQL/и т. п.)
  - Ключи/токены для внешних провайдеров — только через секреты
  - SSL сертификаты/ключи для HTTPS (файлы/секреты)
- Разделение конфигов по окружениям (dev/stage/prod) — через env и/или отдельные `settings_<env>.py`

## CI/CD (pipeline‑outline)

### CI (на каждый PR/commit)

- **Линт и стиль**: ruff/flake8, black (check), isort (check), pylint (по необходимости)
- **Типы**: mypy (async, pydantic‑friendly конфиг)
- **Безопасность**: pip-audit, bandit
- **Тесты**: pytest + pytest‑asyncio; unit + интеграционные (через docker compose services)
- **Сборка артефактов**: Docker‑образы сервисов (например, `api-service`, `worker-service`)
- **Скан образов**: trivy/grype

### CD (по тегу/release или ветке main)

- Публикация образов в реестр с тегами `{version}`, `latest`
- Миграции/инициализация (если применимо)
- Развертывание:
  - вариант A: docker compose (prod‑override файлы)
  - вариант B: Kubernetes (Helm chart: деплойменты для `api-service`, `worker`, управляемая БД/Atlas/Cloud SQL)

### Кэширование и параллелизм

- Кэш Poetry и слои Docker buildx

### Gate’ы и секреты

- Merge‑gate на упавшие тесты/линты/сканы
- Секреты — в Secret Manager/CI secret store; в рантайм — только через env/secret mounts

## Принцип развертывания

- **Контейнеризация**: отдельные образы для API и фоновых воркеров; общий базовый слой (Python 3.11 + Poetry)
- **Хранилище данных**: БД как отдельный сервис/кластер; доступ через `DB_URI`
- **Порты и SSL**: публичный HTTP‑порт (например, `8080`); Uvicorn с `ssl_certfile`/`ssl_keyfile` (секреты/volume mounts в prod)

### Команды (локально)

```bash
make start                 # docker compose up -d
# или
docker compose up -d --build

# Dev без Docker (пример)
poetry install
uvicorn app:create_app --factory --host 0.0.0.0 --port 8080
```

## Наблюдаемость и эксплуатация

- **Логи**: единый логгер приложения, структурированный формат; централизованный сбор в prod
- **Метрики и алерты**: количество запросов, ошибки, латентность, статус фоновых задач, состояние интеграций
- **Трассировка**: опционально OpenTelemetry (exporter → Jaeger/Tempo)

## Минимальные нефункциональные требования

- Идемпотентность критичных эндпоинтов
- Таймауты/ретраи при вызове внешних API
- Ограничение очередей фоновых задач, контроль конкуренции
- Backpressure и rate limits к интеграциям
- Валидация входов/выходов pydantic‑схемами, строгая сериализация
