# Архитектура системы авторизации пользователей

## 1. Система аутентификации и авторизации

### 1.1 Технологический стек

- **Веб-фреймворк**: Quart (Python) - асинхронный фреймворк
- **Система аутентификации**: Quart-Auth или аналогичные решения
- **ORM**: SQLAlchemy с поддержкой async/await
- **Хэширование паролей**: Werkzeug Security
- **Управление сессиями**: Quart Sessions с настройкой постоянности

### 1.2 Компоненты авторизации

#### Менеджер аутентификации

```python
from quart_auth import AuthManager

auth_manager = AuthManager(app)

@auth_manager.user_loader
async def load_user(user_id):
    return await User.get(int(user_id))
```

#### Модель пользователя

Базовая модель предоставляет стандартные методы для работы с аутентификацией:

- `is_authenticated` - проверка аутентификации
- `is_active` - статус активности
- `is_anonymous` - проверка анонимности
- `get_id()` - получение идентификатора

### 1.3 Способы аутентификации

Система поддерживает единственный метод входа:

#### Аутентификация по email

- Эндпоинт: `/login_with_email`
- Поля: `email`, `password`

### 1.4 Управление сессиями

- Настраиваемое время жизни сессий
- Безопасные cookie с HttpOnly флагом
- Поддержка постоянных сессий

## 2. Процесс регистрации

### 2.1 Многоэтапная регистрация

Система реализует **поэтапную регистрацию**, позволяющую пользователям заполнять профиль постепенно:

#### Этапы регистрации

1. **Базовая регистрация**: email, пароль, имя пользователя
2. **Выбор типа профиля**: владелец или приют
3. **Заполнение профиля**: специфическая информация по типу
4. **Дополнительные настройки**: контакты, предпочтения

#### Управление прогрессом

```python
class User:
    registration_step: int  # Текущий шаг регистрации
    profile_type: str      # Тип профиля: owner или shelter
  
    def is_registration_completed(self) -> bool:
        return self.registration_step == COMPLETED_FLAG
  
    def get_current_step(self) -> int:
        return self.registration_step
```

### 2.2 Валидация данных

Каждый этап регистрации включает:

- Валидацию формата данных
- Проверку обязательных полей
- Контроль целостности информации
- Возможность возврата к предыдущим шагам

## 3. Система авторизации доступа

### 3.1 Декораторы защиты

```python
from quart_auth import login_required

@login_required
async def protected_endpoint():
    # Функционал, требующий аутентификации
    pass
```

### 3.2 Middleware для контроля доступа

Автоматическая проверка на каждый запрос:

- Статус аутентификации пользователя
- Подтверждение email для чувствительных операций
- Обновление времени последней активности

### 3.3 Освобожденные маршруты

Список эндпоинтов, доступных без аутентификации:

- Страницы входа и регистрации
- Статические ресурсы
- API документация
- Служебные эндпоинты

## 4. Типы профилей

Система поддерживает два основных типа профилей:

### Профиль будущего хозяина

Предназначен для людей, желающих взять животное:

- Личная информация и контакты
- Жилищные условия
- Опыт содержания животных
- Предпочтения по типу и породе животных
- Финансовые возможности
- etc.

### Профиль приюта

Предназначен для организаций, занимающихся пристройством животных:

- Информация об организации
- Лицензии и документы
- Список доступных животных
- Условия содержания
- Контактная информация и адрес
- etc.

## 5. Безопасность

### Защита данных

- Хэширование паролей
- Валидация пользовательского ввода

## Заключение

Представленная архитектура обеспечивает:

- **Специализацию**: четкое разделение между профилями хозяев и приютов
- **Масштабируемость**: асинхронная архитектура с Quart для высокой нагрузки
